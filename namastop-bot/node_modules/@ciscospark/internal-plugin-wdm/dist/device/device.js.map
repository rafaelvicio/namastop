{"version":3,"sources":["device.js"],"names":["decider","config","ephemeral","Device","SparkPlugin","extend","children","features","FeaturesModel","collections","serviceCatalog","ServiceCollection","idAttribute","namespace","props","clientMessagingGiphy","customerCompanyName","customerLogoUrl","deviceType","helpUrl","intranetInactivityDuration","intranetInactivityCheckUrl","ecmEnabledForAllUsers","type","default","ecmSupportedStorageProviders","modificationTime","partnerCompanyName","partnerLogoUrl","reportingSiteDesc","reportingSiteUrl","searchEncryptionKeyUrl","services","serviceHostMap","serviceLinks","hostCatalog","showSupportText","supportProviderCompanyName","supportProviderLogoUrl","url","userId","webFileShareControl","webSocketUrl","whiteboardFileShareControl","derived","registered","deps","fn","Boolean","session","logoutTimer","lastUserActivityDate","determineService","key","serviceUrl","startsWith","resolve","substr","length","reject","Error","getServiceUrl","service","_getServiceUrl","then","isServiceUrl","getPreDiscoveryServiceUrl","preDiscoveryServices","getWebSocketUrl","useServiceCatalogUrl","uri","inferServiceFromUrl","s","replaceUrlWithCurrentHost","markUrlFailedAndGetNew","logger","info","markFailedAndCycleUrl","spark","internal","metrics","submitClientMetrics","tags","action","failedUrl","newUrl","catch","_resetAllAndRetry","resetAllAndRetry","fetchNewUrls","refresh","on","initialize","args","prototype","forEach","collectionName","model","value","options","trigger","_updateServiceCatalog","listenToAndRun","_resetLogoutTimer","listenTo","Date","now","inspect","depth","util","serialize","isPreDiscoveryService","_isService","isPreDiscoveryServiceUrl","_isServiceUrl","isService","isSpecificService","includes","target","feature","developer","get","register","body","ttl","ephemeralDeviceTTL","request","method","res","_processRegistrationSuccess","reason","statusCode","clear","defaults","resource","unregister","warn","clearTimeout","refreshTimer","set","delay","newRegistration","u","Url","parse","hosts","host","defaultUrl","availableHosts","remove","off","unset","enableInactivityEnforcement","timer","headers","trackingid","logout","oneFlight"],"mappings":"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","file":"device.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {oneFlight} from '@ciscospark/common';\nimport {safeSetTimeout} from '@ciscospark/common-timers';\nimport {omit} from 'lodash';\nimport util from 'util';\nimport FeaturesModel from './features-model';\nimport ServiceCollection from './service-collection';\nimport {persist, waitForValue, SparkPlugin} from '@ciscospark/spark-core';\nimport Url from 'url';\n\n/**\n * Decides if this device should be persisted to boundedStorage, based on\n * this.config.ephemeral.\n * @returns {Boolean}\n */\nfunction decider() {\n  return !this.config.ephemeral;\n}\n\nconst Device = SparkPlugin.extend({\n  children: {\n    features: FeaturesModel\n  },\n\n  collections: {\n    serviceCatalog: ServiceCollection\n  },\n\n  idAttribute: 'url',\n\n  namespace: 'Device',\n\n  props: {\n    /**\n     * Notifies the client if giphys are enabled.\n     * Currently, the values for it are:\n     * - ALLOW\n     * - BLOCK\n     * @instance\n     * @memberof Device\n     * @type {string}\n     */\n    clientMessagingGiphy: 'string',\n    customerCompanyName: 'string',\n    customerLogoUrl: 'string',\n    // deviceType doesn't have any real value, but we need to send it during\n    // device refresh to make sure we don't get back an ios device url\n    deviceType: 'string',\n    helpUrl: 'string',\n    intranetInactivityDuration: 'number',\n    intranetInactivityCheckUrl: 'string',\n    /**\n     * Is ECM (external content management) enabled for the whole org\n     * @instance\n     * @memberof Device\n     * @type {boolean}\n     */\n    ecmEnabledForAllUsers: {\n      type: 'boolean',\n      default: () => false\n    },\n    /**\n     * What ECM providers are available\n     * @instance\n     * @memberof Device\n     * @type {string[]}\n     */\n    ecmSupportedStorageProviders: {\n      type: 'array',\n      default: () => []\n    },\n    modificationTime: 'string',\n    partnerCompanyName: 'string',\n    partnerLogoUrl: 'string',\n    reportingSiteDesc: 'string',\n    reportingSiteUrl: 'string',\n    searchEncryptionKeyUrl: 'string',\n    services: {\n      // Even though @jodykstr will tell you the docs claim you don't need to\n      // initialize `object` properties, the docs lie.\n      default() {\n        return {};\n      },\n      type: 'object'\n    },\n    serviceHostMap: {\n      default() {\n        return {\n          serviceLinks: {},\n          hostCatalog: {}\n        };\n      },\n      type: 'object'\n    },\n    showSupportText: 'boolean',\n    supportProviderCompanyName: 'string',\n    supportProviderLogoUrl: 'string',\n    url: 'string',\n    userId: 'string',\n    /**\n     * Notifies the client if file sharing is disabled.\n     * Currently, the values for it are:\n     * - BLOCK_BOTH\n     * - BLOCK_UPLOAD\n     * @instance\n     * @memberof Device\n     * @type {string}\n     */\n    webFileShareControl: 'string',\n    webSocketUrl: 'string',\n    /**\n     * Notifies the client if whiteboarding should be allowed\n     * regardless of webFileShareControl settings.\n     * Currently, the values for it are:\n     * - ALLOW\n     * - BLOCK\n     * @instance\n     * @memberof Device\n     * @type {string}\n     */\n    whiteboardFileShareControl: 'string'\n  },\n\n  derived: {\n    registered: {\n      deps: ['url'],\n      fn() {\n        return Boolean(this.url);\n      }\n    }\n  },\n\n  session: {\n    // Fun Fact: setTimeout returns a Timer object instead of a Number in Node 6\n    // or later\n    logoutTimer: 'any',\n    lastUserActivityDate: 'number'\n  },\n\n  @waitForValue('@')\n  determineService(url) {\n    for (const key of Object.keys(this.services)) {\n      const serviceUrl = this.services[key];\n      if (url.startsWith(serviceUrl)) {\n        // \"ServiceUrl\" is 10 characters\n        return Promise.resolve(key.substr(0, key.length - 10));\n      }\n    }\n\n    return Promise.reject(new Error(`${url} does not reflect a known service`));\n  },\n\n  @waitForValue('@')\n  getServiceUrl(service) {\n    return this._getServiceUrl(this.services, service)\n      .then((isServiceUrl) => isServiceUrl || this.getPreDiscoveryServiceUrl(service));\n  },\n\n  getPreDiscoveryServiceUrl(service) {\n    // The Promise.resolve here is temporary. A future PR will make the\n    // corresponding _ method async to allow for lazy device registration\n    return Promise.resolve(this._getServiceUrl(this.config.preDiscoveryServices, service));\n  },\n\n  getWebSocketUrl() {\n    return this.useServiceCatalogUrl(this.webSocketUrl);\n  },\n\n  useServiceCatalogUrl(uri) {\n    return this.serviceCatalog.inferServiceFromUrl(uri)\n      .then((s) => s.replaceUrlWithCurrentHost(uri));\n  },\n\n  markUrlFailedAndGetNew(url) {\n    if (!url) {\n      return Promise.reject(new Error('`url` is a required parameter'));\n    }\n\n    this.logger.info(`device: marking ${url} as failed`);\n    return this.serviceCatalog.markFailedAndCycleUrl(url)\n      .then((uri) => {\n        this.spark.internal.metrics.submitClientMetrics('web-ha', {\n          tags: {\n            action: 'replace_url',\n            failedUrl: url,\n            newUrl: uri\n          }\n        });\n        return uri;\n      })\n      // it's likely we fail here because we've cycled though all hosts,\n      // reset all hosts and then retry connecting\n      .catch(() => this._resetAllAndRetry(url));\n  },\n\n  _resetAllAndRetry(url) {\n    if (!url) {\n      return Promise.reject(new Error('`url` is a required parameter'));\n    }\n\n    this.logger.info(`device: reset available hosts and retry ${url}`);\n    return this.serviceCatalog.resetAllAndRetry(url);\n  },\n\n  // this function is exposed beyond the device file\n  fetchNewUrls(url) {\n    // we want to get the current service first, just in case the\n    // refreshed catalog has different host names\n    return new Promise((resolve) => this.serviceCatalog.inferServiceFromUrl(url)\n      .then((s) => {\n        this.logger.info(`device: refresh to ${s.service} get new urls`);\n        this.refresh();\n        this.on('serviceCatalogUpdated', () => resolve(s.url));\n      }));\n  },\n\n  @persist('@', decider)\n  initialize(...args) {\n    Reflect.apply(SparkPlugin.prototype.initialize, this, args);\n\n    // Propagate change(:[attribute]) events from collections\n    ['developer', 'entitlement', 'user'].forEach((collectionName) => {\n      this.features.on(`change:${collectionName}`, (model, value, options) => {\n        this.trigger('change', this, options);\n        this.trigger('change:features', this, this.features, options);\n      });\n    });\n\n    this.on('change:serviceHostMap', this._updateServiceCatalog);\n\n    this.listenToAndRun(this, 'change:intranetInactivityCheckUrl', () => this._resetLogoutTimer());\n    this.listenToAndRun(this, 'change:intranetInactivityDuration', () => this._resetLogoutTimer());\n    this.listenTo(this.spark, 'user-activity', () => { this.lastUserActivityDate = Date.now(); });\n  },\n\n  /**\n   * Don't log the features object\n   * @param {number} depth\n   * @returns {Object}\n   */\n  inspect(depth) {\n    return util.inspect(omit(this.serialize(), 'features'), {depth});\n  },\n\n  isPreDiscoveryService(service) {\n    // The Promise.resolve here is temporary. A future PR will make the\n    // corresponding _ method async to allow for lazy device registration\n    return Promise.resolve(this._isService(this.config.preDiscoveryServices, service));\n  },\n\n  isPreDiscoveryServiceUrl(uri) {\n    // The Promise.resolve here is temporary. A future PR will make the\n    // corresponding _ method async to allow for lazy device registration\n    return Promise.resolve(this._isServiceUrl(this.config.preDiscoveryServices, uri));\n  },\n\n  @waitForValue('@')\n  isService(service) {\n    return this._isService(this.services, service)\n      .then((_isService) => _isService || this.isPreDiscoveryService(service));\n  },\n\n  @waitForValue('@')\n  isServiceUrl(uri) {\n    // The Promise.resolve here is temporary. A future PR will make the\n    // corresponding _ method async to allow for lazy device registration\n    return Promise.resolve(this._isServiceUrl(this.services, uri));\n  },\n\n  @waitForValue('@')\n  isSpecificService(service, key) {\n    if (key === service) {\n      return Promise.resolve(true);\n    }\n\n    return this.getServiceUrl(service)\n      .then((serviceUrl) => key.includes(serviceUrl));\n  },\n\n  _getServiceUrl(target, service) {\n    /* istanbul ignore if */\n    if (!target) {\n      return Promise.reject(new Error('`target` is a required parameter'));\n    }\n\n    if (!service) {\n      return Promise.reject(new Error('`service` is a required parameter'));\n    }\n\n    const feature = this.features.developer.get('web-ha-messaging');\n    if (feature && feature.value) {\n      const s = this.serviceCatalog.get(`${service}ServiceUrl`);\n      if (s) {\n        return Promise.resolve(s.url);\n      }\n    }\n\n    return Promise.resolve(target[`${service}ServiceUrl`]);\n  },\n\n  _isService(target, service) {\n    return this._getServiceUrl(target, service)\n      .then((url) => Boolean(url));\n  },\n\n  _isServiceUrl(target, uri) {\n    if (!uri) {\n      return Promise.reject(new Error('`uri` is a required parameter'));\n    }\n\n    for (const value of Object.values(target)) {\n      if (value && uri.startsWith(value)) {\n        return Promise.resolve(true);\n      }\n    }\n\n    return Promise.resolve(false);\n  },\n\n  @oneFlight\n  @waitForValue('@')\n  refresh() {\n    this.logger.info('device: refreshing');\n\n    if (!this.registered) {\n      this.logger.info('device: device not registered, registering');\n      return this.register();\n    }\n\n    const body = omit(this.serialize(), 'features', 'mediaClusters');\n    if (this.config.ephemeral) {\n      body.ttl = this.config.ephemeralDeviceTTL;\n    }\n\n    return this.request({\n      method: 'PUT',\n      uri: this.url,\n      body\n    })\n      .then((res) => this._processRegistrationSuccess(res))\n      .catch((reason) => {\n        if (reason.statusCode === 404) {\n          // If we get a 404, it means the device is no longer valid and we need\n          // to register a new one.\n          this.logger.info('device: refresh failed with 404, attempting to register new device');\n          this.clear();\n          return this.register();\n        }\n        return Promise.reject(reason);\n      });\n  },\n\n  @oneFlight\n  @waitForValue('@')\n  register() {\n    /* eslint no-invalid-this: [0] */\n    this.logger.info('device: registering');\n\n    if (this.registered) {\n      this.logger.info('device: device already registered, refreshing');\n      return this.refresh();\n    }\n\n    const body = this.config.defaults;\n    if (this.config.ephemeral) {\n      body.ttl = this.config.ephemeralDeviceTTL;\n    }\n\n    return this.request({\n      method: 'POST',\n      service: 'wdm',\n      resource: 'devices',\n      body\n    })\n      .then((res) => this._processRegistrationSuccess(res));\n  },\n\n  @oneFlight\n  @waitForValue('@')\n  unregister() {\n    this.logger.info('device: unregistering');\n\n    if (!this.url) {\n      this.logger.warn('device: not registered');\n      return Promise.resolve();\n    }\n\n    return this.request({\n      uri: this.url,\n      method: 'DELETE'\n    })\n      .then(() => this.clear());\n  },\n\n  clear(...args) {\n    clearTimeout(this.refreshTimer);\n    Reflect.apply(SparkPlugin.prototype.clear, this, args);\n  },\n\n  _processRegistrationSuccess(res) {\n    this.logger.info('device: received registration payload');\n    this.set(res.body);\n    if (this.config.ephemeral) {\n      this.logger.info('device: enqueing device refresh');\n      const delay = (this.config.ephemeralDeviceTTL / 2 + 60) * 1000;\n      this.refreshTimer = safeSetTimeout(() => this.refresh(), delay);\n    }\n  },\n\n  _updateServiceCatalog(newRegistration) {\n    const feature = this.features.developer.get('web-ha-messaging');\n    if (feature && feature.value) {\n      if (newRegistration.serviceHostMap && newRegistration.serviceHostMap.hostCatalog) {\n        Object.keys(newRegistration.services).forEach((service) => {\n          const uri = newRegistration.services[service];\n          const u = Url.parse(uri);\n          const hosts = newRegistration.serviceHostMap.hostCatalog[u.host];\n          this.serviceCatalog.set({\n            service,\n            defaultUrl: uri,\n            availableHosts: hosts || []\n          }, {remove: false});\n        });\n        this.trigger('serviceCatalogUpdated');\n      }\n      else {\n        // if user has old device in localStorage, refresh device\n        this.refresh();\n      }\n    }\n  },\n\n  _resetLogoutTimer() {\n    clearTimeout(this.logoutTimer);\n    this.off('change:lastUserActivityDate'); // removes previous event listener\n    this.unset('logoutTimer');\n    if (this.config.enableInactivityEnforcement && this.intranetInactivityCheckUrl && this.intranetInactivityDuration) {\n      this.on('change:lastUserActivityDate', () => this._resetLogoutTimer());\n      const timer = safeSetTimeout(() => {\n        this.spark.request({\n          headers: {\n            'cisco-no-http-redirect': null,\n            'spark-user-agent': null,\n            trackingid: null\n          },\n          method: 'GET',\n          uri: this.intranetInactivityCheckUrl\n        })\n          .catch(() => {\n            this.logger.info('device: did not reach internal ping endpoint; logging out after inactivity on a public network');\n            return this.spark.logout();\n          })\n          .catch((reason) => {\n            this.logger.warn('device: logout failed', reason);\n          });\n      }, this.intranetInactivityDuration * 1000);\n\n      this.logoutTimer = timer;\n    }\n  }\n});\n\nexport default Device;\n"]}